; RCX - wskaŸnik na tablicê (1 arg), RDX - rozmiar tablicy (2 arg), R8 - 3 arg (wskaŸnik na tab wyj) (kana³y? Chyba olejê, bo nie wiem jak dynamicznie dobieraæ rejestry...)

.data
half DWORD 0.5

.code
StereoToMonoAsm proc

	MOV R9, RDX								;ZAPIS ROZMIARU TABLICY
	SHR R9, 1								;ROZMIAR WYJSCIOWEJ
	XOR R10, R10							;POZYCJA WSKANIKA wej
	XOR R11, R11							;STRA¯NIK WYPE£NIENIA YMM
	XOR R12, R12							;pozycja wskaŸnika wyj
	;VZEROALL

	VBROADCASTSS YMM9, half

wpisz:
	VXORPD  ymm0, ymm0, ymm0
	VXORPD  ymm1, ymm1, ymm1
	VXORPD  ymm2, ymm2, ymm2

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;1 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX

	JZ dodaj
	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;2 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX

	JZ dodaj
	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;3 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX

	JZ dodaj
	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;4 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX
	JZ dodaj									
													
	VPERM2F128 ymm0, ymm0, ymm0, 1H			;SWAP
	VPERM2F128 ymm1, ymm1, ymm1, 1H													

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;5 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX
	
	JZ dodaj
	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;6 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX
	
	JZ dodaj
	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;7 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX
	JZ dodaj

	SHUFPS XMM0, XMM0, 93H
	SHUFPS XMM1, XMM1, 93H

	ADDSS XMM0, DWORD PTR [RCX+(R10*4)]		;8 float
	INC R10
	ADDSS XMM1, DWORD PTR [RCX+(R10*4)]
	INC R10
	INC R11

	DEC RDX
	DEC RDX
	JZ dodaj
	
	

dodaj:
	VADDPS ymm8, ymm0, ymm1
	VMULPS ymm2, ymm8, ymm9
	;VPSRLD ymm2, ymm8, ymm9				;AVX2 NIE DZIA£A MIMO ¯E POWINNO!! >_<

wypisz:

	VPERM2F128 ymm2, ymm2, ymm2, 1H			;SWAP

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;1 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;2 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;3 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;4 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	VPERM2F128 ymm2, ymm2, ymm2, 1H			;SWAP

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;5 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;6 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;7 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	SHUFPS XMM2, XMM2, 93H

	MOVSS DWORD PTR [R8+(R12*4)], XMM2		;8 float

	INC R12
	DEC R9
	JZ koniec

	DEC R11
	JZ WPISZ

	;SHUFPS XMM2, XMM2, 93H


koniec:
	ret
StereoToMonoAsm endp
end